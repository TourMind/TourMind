<main class="container w-11/12 mx-auto flex">
  <div class="flex flex-col mt-10 w-full">
    <div data-controller="share" data-id="<%= @plan.id %>" data-share-target="planId">
      <%= link_to plans_path do %>
        <div class="bg-blue-400 inline-block text-white focus:outline-none focus:ring-4 rounded-full text-md px-3 py-1 hover:bg-white hover:text-blue-500 border-2 transition-all duration-400">
          <span>所有行程</span>
        </div>
      <% end %>
      <% if user_signed_in? %>
        <% if current_user == @plan.user %>
          <%= link_to edit_plan_path(@plan) do %>
            <div class="bg-blue-400 inline-block text-white focus:outline-none focus:ring-4 rounded-full text-md px-3 py-1 hover:bg-white hover:text-blue-500 border-2 transition-all duration-400">
              <span>編輯行程</span>
            </div>
          <% end %>
          <%= link_to plan_path(@plan.id), method: "delete" do %>
            <div class="bg-red-500 inline-block text-white focus:outline-none focus:ring-4 rounded-full text-md px-3 py-1 hover:bg-white hover:text-red-500 border-2 transition-all duration-400">
              <span>刪除行程</span>
            </div>
          <% end %>
          <div class="share-btn relative cursor-pointer inline-block text-white focus:outline-none focus:ring-4 rounded-full text-md px-3 py-1 border-2 transition-all duration-400 select-none" data-action="click->share#toggleSearch" data-share-target="searchBtn">
            <span class="inline-block text-red-500">&#x2665;</span>
            <span>邀請旅伴一起編輯</span>
            <div class="search-drop-down absolute left-0 z-10 w-80 mt-1 text-gray-500 transition-all ease-in-out cursor-default" data-share-target="menu" data-action="click->share#preventProp">
              <div class="relative">
                <form data-action="submit->share#searchUser">
                  <div class="bg-gray-100 w-full h-16 rounded-xl mb-3 shadow-lg p-2 relative ">
                    <input type="text" placeholder="輸入email來尋找旅伴" class="w-full h-full text-md rounded-lg border-none" data-share-target="keyword"/>
                    <div class="absolute right-5 top-0 h-full flex items-center">
                      <button type="submit">
                        <svg class="h-4 w-4 fill-current" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" id="Capa_1" x="0px" y="0px" viewBox="0 0 56.966 56.966" style="enable-background:new 0 0 56.966 56.966;" xml:space="preserve" width="512px" height="512px">
                          <path d="M55.146,51.887L41.588,37.786c3.486-4.144,5.396-9.358,5.396-14.786c0-12.682-10.318-23-23-23s-23,10.318-23,23  s10.318,23,23,23c4.761,0,9.298-1.436,13.177-4.162l13.661,14.208c0.571,0.593,1.339,0.92,2.162,0.92  c0.779,0,1.518-0.297,2.079-0.837C56.255,54.982,56.293,53.08,55.146,51.887z M23.984,6c9.374,0,17,7.626,17,17s-7.626,17-17,17  s-17-7.626-17-17S14.61,6,23.984,6z"/>
                        </svg>
                      </button>
                    </div>
                  </div>
                </form>
                <div class="bg-gray-100 w-full rounded-xl shadow-xl overflow-hidden relative result-hidden transition-all ease-in-out" data-share-target="result">
                  <!-- items -->
                  <%# <div class="w-full flex p-3 pl-4 items-center hover:bg-gray-300 rounded-lg cursor-pointer">
                    <div class="mr-4">
                      <div class="h-11 w-11 rounded-sm flex items-center justify-center">
                        <img class="w-full h-full rounded-full truncate" src="/assets/user_default_avatar-4d250da78bcf1e681853cae1acb1174c0dcf35a31321d507fc27adf6591b2059.png">
                      </div>
                    </div>
                    <div>
                      <div class="font-bold text-lg">Tom</div>
                    </div>
                  </div> %>
                </div>
              </div>
            </div>
          </div>
          <div class="share-btn relative cursor-pointer inline-block text-white focus:outline-none focus:ring-4 rounded-full text-md px-3 py-1 border-2 transition-all duration-400 select-none" data-action="click->share#toggleSharedList" data-share-target="shareBtn">
            <span>共同編輯名單</span>
            <div class="search-drop-down absolute left-0 z-10 w-64 mt-1 text-gray-500 transition-all ease-in-out" data-share-target="sharedList">
              <div class="bg-gray-100 w-full rounded-xl shadow-xl overflow-hidden relative transition-all ease-in-out">
                <!-- items -->
                <div class="w-full flex p-3 pl-4 items-center hover:bg-gray-200 rounded-lg cursor-pointer">
                  <div class="mr-4">
                    <div class="h-11 w-11 rounded-sm flex items-center justify-center">
                      <img class="w-full h-full rounded-full truncate" src="/assets/user_default_avatar-4d250da78bcf1e681853cae1acb1174c0dcf35a31321d507fc27adf6591b2059.png">
                    </div>
                  </div>
                  <div>
                    <div class="font-bold text-lg">Tom</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% else %>
          <%= link_to edit_plan_path(@plan) do %>
            <div class="bg-rose-400 inline-block text-white focus:outline-none focus:ring-4 rounded-full text-md px-3 py-1 hover:bg-white hover:text-red-500 border-2 transition-all duration-400">
              <span class="inline-block text-red-500">&#x2665;</span>
              <span>修改並儲存為自己的行程！</span>
            </div>
          <% end %>
        <% end %>
      <% end %>
    </div>
    <section class="flex w-full h-1/3 mt-3 gap-2 relative">
      <% if @plan.images.length == 0 %>
        <div class="h-full w-full overflow-hidden">
          <img src="https://fakeimg.pl/1920x1080/?text=TourMind" class="object-cover w-full h-full">
        </div>
      <% elsif @plan.images.length == 1 %>
        <div class="h-full w-full overflow-hidden">
          <img src="<%= @plan.images[0] %>" class="object-cover w-full h-full">
        </div>
      <% elsif @plan.images.length == 2 %>
        <div class="h-full w-1/2 overflow-hidden">
          <img src="<%= @plan.images[0] %>" class="object-cover w-full h-full">
        </div>
        <div class="h-full w-1/2 overflow-hidden">
          <img src="<%= @plan.images[1] %>" class="object-cover w-full h-full">
        </div>
      <% else %>
        <button class="flex justify-center opacity-80 group absolute right-3 bottom-3 h-7 w-28 overflow-hidden rounded-full bg-slate-800 text-lg shadow">
          <div class="absolute inset-0 w-0 bg-white transition-all duration-[250ms] ease-out group-hover:w-full"></div>
          <span class="relative text-white group-hover:text-black text-sm self-center">查看所有照片</span>
        </button>
        <div class="h-full w-2/3 overflow-hidden">
          <img src="<%= @plan.images[0] %>" class="object-cover w-full h-full">
        </div>
        <div class="h-full w-1/3 flex flex-col gap-2">
          <div class="h-1/2 w-full overflow-hidden">
            <img src="<%= @plan.images[1] %>"  class="object-cover w-full h-full">
          </div>
          <div class="h-1/2 w-full  overflow-hidden">
            <img src="<%= @plan.images[2] %>"  class="object-cover w-full h-full">
          </div>
        </div>
      <% end %>
    </section>
    <section class="mx-3">
      <div class=" w-2/3">
        <h1 class="mt-8 text-3xl font-medium"><%= @plan.name %></h1>
        <p class="mt-2 text-sm underline text-slate-700"><a href="">提供者： <%= @plan.user.name.present? ? @plan.user.name : @plan.user.email %> </a></p>
        <div class="flex items-center my-3">
          <span><%= star_rating(@plan_data[@plan.id][:average_rating]) %>
            <%= sprintf('%.1f', @plan_data[@plan.id][:average_rating]) %>
            (<%= @plan_data[@plan.id][:comment_count] %>則評論)
          </span>
        </div>
        <p class="my-3 w-3/4 text-slate-700 text-m"><%= @plan.description %></p>
        <div class="border-y-2 border-slate-300 w-full">
          <p class="my-3 text-slate-700 text-m">適合人數： <%= @plan.people || 1 %> 人</p>
          <p class="my-3 text-slate-700 text-m">所需時間： <%= @plan.days %> 天</p>
          <p class="my-3 text-slate-700 text-m">分類： <%= @plan.category %></p>
          <% if user_signed_in? && current_user == @plan.user %>
            <p class="my-3 text-blue-600 text-m">行程公開狀態： <%= @plan.public ? "所有人皆可查看" : "私人行程" %></p>
          <% end %>
        </div>
      </div>
    </section>
    <%= render "plan_overview"%>
  </div>
</main>
<div class="mx-auto container bg-white col-span-5">
  <h2 class="font-bold text-2xl ">評等和評論</h2>
  <div class="overflow-y-auto h-40 ">
    <div id="comment-list">
      <%= render partial: "comment", collection: @plan.comments %>
    </div>
  </div>
</div>
<section class='w-full mx-auto container'>
  <div data-controller="butt">
    <a data-action="click->butt#toggleCommentForm" class="mt-2 rounded-lg py-3 px-5 bg-gray-100 inline-block font-medium" href="#comment-form">
      發表評論
    </a>
    <div class="hidden" data-butt-target="form" >
      <%= render "comments/comment", comment: Comment.new, plan:@plan %>
    </div>
  </div>
</section>
